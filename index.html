<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Robinhood Portfolio</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css" integrity="sha384-oAOxQR6DkCoMliIh8yFnu25d7Eq/PHS21PClpwjOTeU2jRSq11vu66rf90/cZr47" crossorigin="anonymous">
    <style>
textarea[name=auth-token] {
    width: 80%;
    height: 10rem;
}
    </style>
</head>

<body>
    <h1>Robinhood Portfolio</h1>
    <form class="pure-form pure-form-aligned">
        <div class="pure-control-group">
            <label for="auth-token">Auth Token</label>
            <textarea name="auth-token"></textarea>
        </div>
        <div class="pure-control-group">
            <label for="account">Account</label>
            <input type="text" name="account"/>
        </div>
        <div class="pure-controls">
            <button type="submit" class="pure-button pure-button-primary">
                Get Portfolio
            </button>
        </div>
    </form>
    <h2>Breakdown by categories</h2>
    <table class="portfolio pure-table">
        <thead>
            <th>Category</th>
            <th>Percentage (%)</th>
            <th>Target (%)</th>
            <th>Value</th>
        </thead>
        <tbody>
        </tbody>
    </table>
    <!-- <script src="https://unpkg.com/jwt-decode@2.2.0/build/jwt-decode.min.js"></script> -->
    <script type="module">
        import { getPortfolio } from './portfolio.js';
        import money from 'https://unpkg.com/@tridnguyen/usd-formatter@1.0.1/index.js';

        window.BASE_URL = 'https://us-central1-build-tridnguyen-com.cloudfunctions.net/robinhoodProxy'

        const authTokenField = document.querySelector('[name=auth-token]');
        const authToken = localStorage.getItem('auth_token');
        if (authToken) {
            authTokenField.value = authToken;
            window.AUTH_TOKEN = authToken;
        }
        const account = localStorage.getItem('account');
        if (account) {
            document.querySelector('[name=account]').value = account;
        }
        const tbody = document.querySelector('.portfolio tbody');
        getPortfolio(account).then(port => {
            Object.keys(port.byCategories).forEach(catId => {
                const cat = port.byCategories[catId];
                const actualPercentage = cat.total / port.marketValue;
                const color = actualPercentage < cat.percentage ? "yellow" : "blue";
                const tr = document.createElement('tr');
                const catTd = document.createElement('td');
                const catText = document.createTextNode(cat.name);
                catTd.appendChild(catText);

                const actualPercentTd = document.createElement('td');
                const actualPercentText = document.createTextNode((actualPercentage * 100).toFixed(2));
                actualPercentTd.appendChild(actualPercentText);

                const percentTd = document.createElement('td');
                const percentText = document.createTextNode(cat.percentage * 100);
                percentTd.appendChild(percentText);

                const totalTd = document.createElement('td');
                const totalText = document.createTextNode(money(cat.total));
                totalTd.appendChild(totalText);

                tr.appendChild(catTd);
                tr.appendChild(actualPercentTd);
                tr.appendChild(percentTd);
                tr.appendChild(totalTd);

                tbody.appendChild(tr);
            });
        }, err => {
            if (err.message == 'Incorrect authentication credentials.') {
                // if incorrect auth, delete stored auth token
                localStorage.removeItem('auth_token');
                authTokenField.value = '';
            }
        });
    </script>
</body>
